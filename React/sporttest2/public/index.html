<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="google" content="notranslate">
	<link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1" /> -->
	<meta name="theme-color" content="#000000" />
	<meta name="description" content="Web site created using create-react-app" />
	<link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

	<!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
	<link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
	<!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
	<title>React App</title>

	<style>
		html, body, #root {
			height: 100vh; /*給 Safari 以外的瀏覽器讀取*/
			height: calc(var(--vh, 1vh) * 100);
			overflow: hidden;
		}
	</style>
</head>

<body style="overflow: hidden;">
	<noscript>You need to enable JavaScript to run this app.</noscript>
	<div id="root" style="overflow: hidden;"></div>
	<!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
	<script>
		// var player = 2 ;
		// var token = '827ccb0eea8a706c4c34a16891f84e7b' ;
		// var lang = 'tw'

		var player = @json(session('player.id'));
		var token = @json(session('player.token'));
		var lang = @json(session('player.lang'));

		// 菜單與體育彩種預設
		var menu = null
		// var sport = null
		var sport = '{{ $system_config["default_sport"] }}'

		// Ajax用
		var ajaxInt = null

		// websocket用
		const messageQueue = []; // queue to store the package (FIFO)
		var socket_status = false;
		var ws = null
		var heartbeatTimer = null
		var registerMatchList = []
		var wsInt = null
		var wsStatus = null

		// websocket
		function WebSocketDemo( ) {
			console.log('WebSocketDemo')
			if ("WebSocket" in window) {
				try {
					ws = new WebSocket('wss://broadcast.asgame.net/ws'); // 連線
					ws.onopen = function() {
						wsInt = setInterval(reconnent, 5000); // detect ws connetion state
						
						// register
						const wsMsg = {
							"action": "register",
							"sport_id": sport,
							"player": player,
						}
						console.log('ws match send -> ')
						console.log(wsMsg)
						ws.send(JSON.stringify(wsMsg));


						socket_status = true; // for reconnection
						heartbeatTimer = setInterval(() => { // 心跳 
							const heartbeat = {
								"action": "heartbeat",
							}
							console.log(heartbeat)
							ws.send(JSON.stringify(heartbeat));
						}, 10000);
					};

					// websocket is closed
					ws.onclose = function(event) {
						console.log('Connection closed with code: ', event.code);
						socket_status = false;
						clearInterval(heartbeatTimer) // 移除心跳timer
						clearInterval(wsInt)
					};

					// websocket is getting message
					ws.onmessage = function(message) {
						messageQueue.push(message); // push package to messageQueue
					}
				} catch (error) {
				}
			} else {
				console.log("WebSocket NOT supported by your Browser!");
			}
		}

		 
		// 重連機制
		function reconnent() {
			if (socket_status === false) {
				WebSocketDemo( window.sport );
			}
		}

		function safariHacks() {
			let windowsVH = window.innerHeight / 100;
			document.querySelector('html').style.setProperty('--vh', windowsVH + 'px');
			document.querySelector('body').style.setProperty('--vh', windowsVH + 'px');
			document.querySelector('#root').style.setProperty('--vh', windowsVH + 'px');
			window.addEventListener('resize', function() {
				console.log('resize')
				let windowsVH = window.innerHeight / 100;
				console.log(windowsVH)
				document.querySelector('html').style.setProperty('--vh', windowsVH + 'px');
				document.querySelector('body').style.setProperty('--vh', windowsVH + 'px');
				document.querySelector('#root').style.setProperty('--vh', windowsVH + 'px');
			});
		}
		
		// 網頁高度偵測
		safariHacks();

	</script>

</body>

</html>